---
import { Region } from "@components/layout-primitives";
---

<Region as="header" density="flat">
	<supple-masthero class="masthero">
		<div class="masthero__inner | retain" data-size="mural">
			<div class="masthero__wrap-text">
				<span class="text-huge-cq font-semibold leading-fine text-balance"
					><span class="masthero__text" data-module="supple-masthero__text"
						><span class="masthero__first">Stunning websites</span><span class="masthero__dot" data-index="1">.</span> Fast,
						flexible, and built with care<span class="masthero__dot" data-index="2">.</span> This is <em>supple</em
						><span class="masthero__dot" data-index="3">.</span> And it works<span class="masthero__dot" data-index="4"
							>.</span
						></span
					></span
				>
			</div>
		</div>
	</supple-masthero>
</Region>

<script>
	class SuppleMasthero extends HTMLElement {
		_resizeObserver: ResizeObserver | null = null;
		_pendingRAF = false;
		_textElement: HTMLElement | null = null;

		connectedCallback() {
			this._textElement = this.querySelector('[data-module="supple-masthero__text"]');

			this._resizeObserver = new ResizeObserver(() => {
				if (!this._pendingRAF) {
					this._pendingRAF = true;
					requestAnimationFrame(() => this._handleResize());
				}
			});

			this._resizeObserver.observe(this);
		}

		disconnectedCallback() {
			if (this._resizeObserver) {
				this._resizeObserver?.disconnect();
				this._resizeObserver = null;
			}
			this._pendingRAF = false;
		}

		_handleResize() {
			this._pendingRAF = false;

			const { height } = this._textElement?.getBoundingClientRect() || { height: 0 };
			const lineHeight = window.getComputedStyle(this._textElement || this).lineHeight;
			const numberOfLines = Math.floor(height / Number.parseFloat(lineHeight));
			this.style.setProperty("--masthero-lines", numberOfLines.toString());
		}
	}
	customElements.define("supple-masthero", SuppleMasthero);
</script>

<style is:global>
	:where(:root) {
		--masthero-min-block-size: 300lvh;
	}
</style>

<style>
	/*
	1. Reset region block padding since we're moving it to the inner div
	2. `lh` unit is not supported everywhere yet, so we need a fallback
	*/
	.masthero {
		/* @TODO: Fix underline-block-width when tekst is to large (smaller screens) */
		--_masthero-underline-width: 1.09em; /* [2] */
		--_masthero-underline-width: 1lh; /* [2] */
		--_masthero-underline-color: light-dark(var(--color-zinc), var(--color-foreground-shade));
		--_masthero-accent: var(--color-primary-background);
		--_masthero-fill: light-dark(var(--color-secondary-background), var(--color-zinc));
		--_masthero-finish-fill: var(--color-surface-foreground);
		--_masthero-animation-color-in-range: cover 70% exit 0%;
		--_masthero-lines: var(--masthero-lines, 5);

		display: block;
		padding-block: 0; /* [1] */
	}

	.masthero__inner {
		padding-block: var(--spacing-region); /* [1] */
	}

	.masthero__wrap-text {
		--_masthero-underline-block-width: calc(100cqi * var(--_masthero-lines));
	}

	.masthero__text {
		text-decoration: none;
		color: var(--_masthero-finish-fill);
	}

	.masthero__dot {
		color: var(--_masthero-accent);
	}

	@supports (animation-timeline: scroll()) {
		/* Same @media as Masthead */
		@media (prefers-reduced-motion: no-preference) {
			.masthero {
				view-timeline-name: --masthero;
				min-block-size: var(--masthero-min-block-size);
			}

			.masthero__inner {
				position: sticky;
				inset-block-start: var(--masthead-block-size, 0px);
				display: grid;
				place-items: center;
				min-block-size: calc(100lvh - var(--masthead-block-size, 0px));
				padding-block: var(--spacing-bleed);
			}

			.masthero__text,
			.masthero__first,
			.masthero__dot {
				animation-fill-mode: both;
				animation-timing-function: linear;
				animation-timeline: --masthero;
			}

			.masthero__text {
				background-image:
					/* First one is the highlight */
					linear-gradient(90deg, transparent calc(100% - 1ch), var(--_masthero-accent) calc(100% - 1ch)),
					linear-gradient(90deg, var(--_masthero-fill), var(--_masthero-fill)),
					linear-gradient(90deg, var(--_masthero-underline-color), var(--_masthero-underline-color));
				background-size:
					var(--_masthero-underline-block-width) var(--_masthero-underline-width),
					var(--_masthero-underline-block-width) var(--_masthero-underline-width),
					100% var(--_masthero-underline-width);
				background-repeat: no-repeat;
				background-clip: text;
				background-position-x:
					calc(var(--_masthero-underline-block-width) * -1), calc(var(--_masthero-underline-block-width) * -1), 0;
				background-position-y: 100%;
				color: transparent;
				animation-name: fill-up, color-in;
				animation-range:
					entry 67% cover 70%,
					var(--_masthero-animation-color-in-range);
			}

			.masthero__first {
				color: var(--_masthero-fill);
				animation-name: color-in;
				animation-range: var(--_masthero-animation-color-in-range);
			}

			.masthero__dot {
				color: transparent;
				animation-name: color-dot;
				animation-range: cover 65% exit -30%;
			}

			.masthero__dot[data-index="1"] {
				color: var(--_masthero-accent);
			}

			@keyframes fill-up {
				to {
					background-position-x: 0, 0, 0;
				}
			}

			@keyframes color-in {
				to {
					color: var(--_masthero-finish-fill);
				}
			}

			@keyframes color-dot {
				to {
					color: var(--_masthero-accent);
					/* color: blue; */
				}
			}
		}
	}
</style>
